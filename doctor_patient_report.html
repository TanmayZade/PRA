<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard - Patient Report</title>
  <style>
    /* Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #f8fafc;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 1rem;
      color: #2563eb;
    }
    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border: none;
    }
    th {
      font-weight: 600;
      color: #2563eb;
      background: #f1f5f9;
    }
    /* Form styles */
    .form-group {
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    textarea, input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 1rem;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .btn-small {
      padding: 0.3rem 0.75rem;
      font-size: 0.9rem;
      margin-left: 0.5rem;
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
    }
    .list-container {
      margin-top: 0.5rem;
    }
    .list-container span {
      display: inline-block;
      background: #e2e8f0;
      padding: 5px 10px;
      border-radius: 5px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .remove-btn {
      background: red;
      color: white;
      border: none;
      padding: 2px 5px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Patient Report</h2>
    <table id="reportTable">
      <thead>
        <tr>
          <th>Patient Name</th>
          <th>Gender</th>
          <th>Blood Group</th>
          <th>Patient ID</th>
          <th>Contact Number</th>
          <th>Appointment Date & Time</th>
        </tr>
      </thead>
      <tbody>
        <tr id="reportRow">
          <!-- Data will be inserted here -->
        </tr>
      </tbody>
    </table>

    <!-- create new div where we will return text generated by flask with name AI analysis of Patient Medical history -->
    <!-- AI Analysis Section -->
    <div class="form-group">
      <h3>AI Analysis of Patient Medical History</h3>
      <div id="aiAnalysis" style="background: #f1f5f9; padding: 1rem; border-radius: 6px; min-height: 50px;">
        Loading AI analysis...
      </div>
    </div>


      <!-- Symptoms Input -->
      <div class="form-group">
        <label for="symptomInput">Symptoms</label>
        <input type="text" id="symptomInput" placeholder="Enter symptom..." />
        <button type="button" class="btn btn-small" onclick="addSymptom()">Add</button>
        <div id="symptomList" class="list-container"></div>
      </div>

      <!-- Medications Input -->
      <div class="form-group">
        <label for="medicationInput">Medications</label>
        <input type="text" id="medicationInput" placeholder="Enter medication..." />
        <button type="button" class="btn btn-small" onclick="addMedication()">Add</button>
        <div id="medicationList" class="list-container"></div>
      </div>

      <form id="reportForm">
        <div class="form-group">
          <label for="reportText">Additional Report Notes</label>
          <textarea id="reportText" name="reportText" rows="5" placeholder="Enter additional report details..."></textarea>
      </div>


      <div class="form-group">
        <h3>AI Symptom & Medication Analysis</h3>
        <button class="btn" onclick="fetchAIAnalysis()">Generate AI Analysis</button>
        <div id="sm_analysis" style="background: #f1f5f9; padding: 1rem; border-radius: 6px; min-height: 50px; margin-top: 1rem;">
          AI analysis will appear here...
        </div>
      </div>
      
      <!-- Hidden input for patient ID -->
      <input type="hidden" id="patientId" name="patientId">
      <input type="hidden" id="sm_analysis_input" name="sm_analysis">
      <input type="hidden" id="aiAnalysis" name="aiAnalysis">


      <!-- create button with name access report , when button is clicked a text will be added which will be returned from flask with name PMS_analysis -->
      <button type="submit" class="btn">Submit Report</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
const symptoms = [];
    const medications = [];
  
    function addSymptom() {
      const symptomInput = document.getElementById("symptomInput");
      if (symptomInput.value.trim() !== "") {
        symptoms.push(symptomInput.value.trim());
        updateList("symptomList", symptoms);
        symptomInput.value = "";
      }
    }
  
    function addMedication() {
      const medicationInput = document.getElementById("medicationInput");
      if (medicationInput.value.trim() !== "") {
        medications.push(medicationInput.value.trim());
        updateList("medicationList", medications);
        medicationInput.value = "";
      }
    }
  
    function updateList(elementId, array) {
      const list = document.getElementById(elementId);
      list.innerHTML = "";
      array.forEach((item, index) => {
        list.innerHTML += `<span>${item} <button class="remove-btn" onclick="removeItem('${elementId}', ${index})">x</button></span>`;
      });
    }
  
    function removeItem(elementId, index) {
      if (elementId === "symptomList") {
        symptoms.splice(index, 1);
        updateList(elementId, symptoms);
      } else if (elementId === "medicationList") {
        medications.splice(index, 1);
        updateList(elementId, medications);
      }
    }


    async function fetchAIAnalysis() {
    try {
        const token = localStorage.getItem("token");  // Fetch authentication token (if required)
        const symptomsData = symptoms.join(", ");  // Convert symptoms array to a comma-separated string
        const medicationsData = medications.join(", ");  // Convert medications array to a comma-separated string
        const patientId = document.getElementById("patientId").value;  // Get patient ID from the hidden input
        const appointmentId = new URLSearchParams(window.location.search).get("appointmentId");  // Extract appointment ID from URL

        // Check if required fields are available
        if (!symptomsData && !medicationsData) {
            document.getElementById("sm_analysis").innerHTML = "<p style='color: red;'>Please enter symptoms or medications.</p>";
            return;
        }

        if (!patientId || !appointmentId) {
            document.getElementById("sm_analysis").innerHTML = "<p style='color: red;'>Error: Missing Patient ID or Appointment ID.</p>";
            return;
        }

        // Send data to Flask backend
        const response = await fetch("http://localhost:5000/analyze", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token  // Send token for authentication (if required)
            },
            body: JSON.stringify({
                patientID: patientId,   // Include patient ID
                appointmentID: appointmentId,  // Include appointment ID
                symptoms: symptomsData,
                medications: medicationsData
            })
        });

        // Handle server errors
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        // Parse JSON response
        const data = await response.json();
        
        // Display AI-generated analysis in the `#sm_analysis` div
        document.getElementById("sm_analysis").innerHTML = `<pre>${data.analysis}</pre>`;

        // Store AI-generated analysis in hidden input field for submission
        document.getElementById("sm_analysis_input").value = data.analysis;
      } catch (error) {
        console.error("Error fetching AI analysis:", error);
        document.getElementById("sm_analysis").innerHTML = "<p style='color: red;'>Failed to generate analysis.</p>";
    }
}

async function fetchPMSAnalysis() {
    try {
        // Extract patientId from the page content (hidden input field)
        let patientId = document.getElementById("patientId")?.value;

        // If patientId is not set, try fetching from URL parameters
        if (!patientId) {
            patientId = new URLSearchParams(window.location.search).get("patientId");
        }

        // If still missing, show an error message
        if (!patientId) {
            document.getElementById("aiAnalysis").innerHTML = "<p style='color: red;'>Error: Patient ID is missing.</p>";
            return;
        }

        const token = localStorage.getItem("token");

        console.log("Fetching AI analysis for patient ID:", patientId);

        // Make API request using correct URL structure
        const response = await fetch(`http://localhost:5000/doctor/patient_history/?patientId=${patientId}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            }
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.text(); // Expecting plain text response
        console.log("Fetched AI Analysis:", data);

        document.getElementById("aiAnalysis").innerHTML = `<pre>${data}</pre>`;
    } catch (error) {
        console.error("Error fetching PMS analysis:", error);
        document.getElementById("aiAnalysis").innerHTML = "<p style='color: red;'>Failed to load AI analysis.</p>";
    }
}




    // Fetch patient report data
    async function loadReportData() {
      try {
        const appointmentId = new URLSearchParams(window.location.search).get("appointmentId");
        const token = localStorage.getItem("token");

        const response = await fetch(`http://localhost:5000/doctor/reportdata?appointmentId=${appointmentId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          }
        });

        const data = await response.json();
        if (data.error) {
          document.getElementById("message").textContent = data.error;
          document.getElementById("message").style.color = "red";
          return;
        }

        const row = document.getElementById("reportRow");
        row.innerHTML = `
          <td>${data.patientName || "Unknown"}</td>
          <td>${data.gender || "Unknown"}</td>
          <td>${data.bloodGroup || "Unknown"}</td>
          <td>${data.patientID || "Unknown"}</td>
          <td>${data.contactNumber || "Unknown"}</td>
          <td>${data.appointmentDateTime || "Unknown"}</td>
        `;

        if (data.patientID) {
          document.getElementById("patientId").value = data.patientID;
          fetchPMSAnalysis(data.patientID); // Fetch AI Analysis using Patient ID
        }
      } catch (error) {
        console.error("Error loading report data:", error);
        document.getElementById("message").textContent = "Error connecting to server.";
      }
    }

    // Submit the medical report form
    document.getElementById("reportForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const appointmentId = new URLSearchParams(window.location.search).get("appointmentId");
      const reportText = document.getElementById("reportText").value;
      const patientId = document.getElementById("patientId").value;
      const token = localStorage.getItem("token");

      if (!patientId) {
        document.getElementById("message").textContent = "Patient ID is missing!";
        document.getElementById("message").style.color = "red";
        return;
      }
      const smAnalysisValue = document.getElementById("sm_analysis_input").value;

      const reportData = {
        appointmentId: appointmentId,
        symptoms: symptoms,
        medications: medications,
        patientId: patientId,
        reportText: reportText,
        aiSummary: "smAnalysisValue", // Pass AI Summary
        doctor: "dr_john" // Replace with the logged-in doctor's name if available
      };

      try {
        const response = await fetch("http://localhost:5000/doctor/save_medical_history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(reportData)
        });

        const result = await response.json();

        if (response.ok) {
          document.getElementById("message").textContent = "Report submitted successfully!";
          document.getElementById("message").style.color = "green";
        } else {
          document.getElementById("message").textContent = result.error || "Failed to submit report.";
          document.getElementById("message").style.color = "red";
        }
      } catch (error) {
        console.error("Error submitting report:", error);
        document.getElementById("message").textContent = "Error connecting to server.";
      }
    });

    window.onload = loadReportData;
  </script>
</body>
</html>

